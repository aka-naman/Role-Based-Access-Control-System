{% extends "base.html" %}

{% block title %}{{ tab.name }} - Data Management Portal{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ tab.department.name }} - {{ tab.name }}</h1>
    <p>{{ tab.description|default:"Tab containing structured records" }}</p>
</div>

<div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {% if can_add %}
    <button id="addRowBtn" class="btn btn-success">‚ûï Add Record</button>
    <a href="{% url 'import_excel' tab.id %}" class="btn btn-info">üìä Import Excel</a>
    {% endif %}
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<!-- AG Grid CSS from CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.0/dist/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.0/dist/styles/ag-theme-quartz.css">

<!-- AG Grid Container -->
<div id="myGrid" class="ag-theme-quartz" style="height: 700px; width: 100%;"></div>

<style>
    .ag-theme-quartz {
        --ag-borders-side-color: #ddd;
        --ag-header-height: 40px;
        --ag-row-height: 32px;
    }
    
    .ag-root-wrapper {
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.0/dist/ag-grid-community.min.js"></script>

<script>
    const tabId = {{ tab.id }};
    const canEdit = {{ can_edit|lower }};
    const canDelete = {{ can_delete|lower }};
    
    let gridApi;
    let gridColumnApi;
    
    // Grid options configuration
    const gridOptions = {
        columnDefs: [],
        rowData: [],
        defaultColDef: {
            flex: 1,
            minWidth: 100,
            sortable: true,
            filter: 'agTextColumnFilter',
            floatingFilter: true,
            resizable: true,
            editable: canEdit
        },
        pagination: true,
        paginationPageSize: 20,
        suppressPaginationPanel: false,
        paginationAutoPageSize: false,
        suppressDragLeaveHidesColumns: true,
        stopEditingWhenGridLosesFocus: true,
        onGridReady: onGridReady,
        onCellValueChanged: onCellValueChanged,
        rowClassRules: {
            'new-row': params => params.data.id === null || params.data.id === undefined
        },
        components: {},
        context: {
            canDelete: canDelete,
            canEdit: canEdit
        }
    };
    
    // Initialize the grid when DOM is ready
    function initializeGrid() {
        console.log('Starting AG Grid initialization...');
        
        // Fetch data and columns from API
        fetch(`/api/tab/${tabId}/records/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(apiData => {
                console.log('API Data received:', apiData);
                
                if (!apiData.data || !apiData.columns) {
                    throw new Error('Invalid API response: missing data or columns');
                }
                
                // Build column definitions
                const columnDefs = buildColumnDefs(apiData.columns);
                gridOptions.columnDefs = columnDefs;
                gridOptions.rowData = apiData.data;
                
                // Create the grid
                const eGridDiv = document.querySelector('#myGrid');
                new agGrid.Grid(eGridDiv, gridOptions);
                
                console.log('AG Grid initialized successfully with ' + apiData.data.length + ' records');
            })
            .catch(error => {
                console.error('Error initializing grid:', error);
                document.getElementById('myGrid').innerHTML = 
                    '<p style="color: red; padding: 20px;">Error loading grid: ' + error.message + '</p>';
            });
    }
    
    function buildColumnDefs(columnNames) {
        const columnDefs = [];
        
        // ID column (read-only)
        columnDefs.push({
            headerName: 'ID',
            field: 'id',
            width: 70,
            sortable: true,
            filter: true,
            editable: false,
            type: 'numericColumn'
        });
        
        // Data columns
        columnNames.forEach(col => {
            if (col !== 'id') {
                columnDefs.push({
                    headerName: col,
                    field: col,
                    flex: 1,
                    minWidth: 120,
                    sortable: true,
                    filter: true,
                    editable: canEdit,
                    cellStyle: { padding: '8px' }
                });
            }
        });
        
        // Actions column
        if (canDelete) {
            columnDefs.push({
                headerName: 'Actions',
                field: 'actions',
                width: 100,
                editable: false,
                sortable: false,
                filter: false,
                cellRenderer: actionsCellRenderer,
                cellRendererParams: {
                    canDelete: canDelete
                }
            });
        }
        
        return columnDefs;
    }
    
    // Custom cell renderer for actions
    function actionsCellRenderer(params) {
        if (!params.context.canDelete) {
            return '';
        }
        
        const button = document.createElement('button');
        button.innerHTML = 'üóëÔ∏è Delete';
        button.className = 'btn btn-sm btn-danger';
        button.style.padding = '4px 8px';
        button.style.fontSize = '12px';
        button.onclick = () => deleteRecord(params.data.id);
        return button;
    }
    
    function onGridReady(params) {
        gridApi = params.api;
        gridColumnApi = params.columnApi;
        console.log('Grid API ready');
        
        // Initialize Add Record button handler now that gridApi is ready
        initializeAddRowButton();
    }
    
    function initializeAddRowButton() {
        const addRowBtn = document.getElementById('addRowBtn');
        if (addRowBtn && canEdit) {
            addRowBtn.onclick = function() {
                const newRow = {
                    id: null
                };
                
                // Initialize all data columns with empty strings
                const columns = gridApi.columnController.getAllGridColumns();
                columns.forEach(col => {
                    const field = col.colDef.field;
                    if (field !== 'id' && field !== 'actions') {
                        newRow[field] = '';
                    }
                });
                
                // Add row to the top
                gridApi.applyTransaction({
                    add: [newRow],
                    addIndex: 0
                });
            };
        }
    }
    
    function onCellValueChanged(event) {
        const record = event.data;
        const colKey = event.colDef.field;
        
        // Skip ID and actions columns
        if (colKey === 'id' || colKey === 'actions' || !colKey) return;
        
        const newValue = event.newValue;
        
        console.log(`Cell changed: ${colKey} = ${newValue}`);
        
        // If this is a new record (id is null), create it first
        if (!record.id || record.id === null) {
            createNewRecord(record);
            return;
        }
        
        // Update existing record
        updateRecord(record.id, colKey, newValue, event);
    }
    
    function createNewRecord(record) {
        // Build data object from record, excluding id and actions
        const newData = {};
        const columns = gridApi.columnController.getAllGridColumns();
        
        columns.forEach(col => {
            const field = col.colDef.field;
            if (field !== 'id' && field !== 'actions') {
                newData[field] = record[field] || '';
            }
        });
        
        console.log('Creating new record:', newData);
        
        fetch(`/api/tab/${tabId}/records/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(newData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update row with new ID from server
                record.id = data.id;
                gridApi.applyTransaction({ update: [record] });
                console.log('Record created with ID:', data.id);
                showNotification('Record created successfully', 'success');
            } else {
                showNotification('Error creating record: ' + data.error, 'error');
                gridApi.applyTransaction({ remove: [record] });
            }
        })
        .catch(error => {
            console.error('Error creating record:', error);
            showNotification('Failed to create record', 'error');
            gridApi.applyTransaction({ remove: [record] });
        });
    }
    
    function updateRecord(recordId, field, value, event) {
        console.log(`Updating record ${recordId}: ${field} = ${value}`);
        
        fetch(`/api/record/${recordId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                [field]: value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Record updated successfully');
                showNotification('Record updated', 'success');
            } else {
                console.error('Update error:', data.error);
                showNotification('Error: ' + data.error, 'error');
                // Reload the row from server
                gridApi.applyTransaction({ remove: [event.data] });
            }
        })
        .catch(error => {
            console.error('Error updating record:', error);
            showNotification('Failed to save record', 'error');
        });
    }
    
    function deleteRecord(recordId) {
        if (!confirm('Are you sure you want to delete this record?')) {
            return;
        }
        
        console.log('Deleting record:', recordId);
        
        fetch(`/api/record/${recordId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find and remove row from grid
                const rowNode = gridApi.getRowNode(String(recordId));
                if (rowNode) {
                    gridApi.applyTransaction({ remove: [rowNode.data] });
                }
                showNotification('Record deleted successfully', 'success');
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting record:', error);
            showNotification('Failed to delete record', 'error');
        });
    }
    
    function showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            animation: slideIn 0.3s ease-in-out;
        `;
        
        if (type === 'success') {
            notification.style.backgroundColor = '#28a745';
            notification.style.color = 'white';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#dc3545';
            notification.style.color = 'white';
        } else {
            notification.style.backgroundColor = '#17a2b8';
            notification.style.color = 'white';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Add row button handler is initialized in onGridReady callback when gridApi is ready
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGrid);
    } else {
        initializeGrid();
    }
</script>

{% endblock %}
