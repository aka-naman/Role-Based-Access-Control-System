{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ tab.name }} - Data Management Portal{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ tab.department.name }} - {{ tab.name }}</h1>
    <p>{{ tab.description|default:"Tab containing structured records" }}</p>
</div>

<div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {% if can_add %}
    <a href="{% url 'add_record' tab.id %}" class="btn btn-success">‚ûï Add Record</a>
    <a href="{% url 'import_excel' tab.id %}" class="btn btn-info">üìä Import Excel</a>
    {% endif %}
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<!-- Search & Filter Bar -->
{% if records %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-body">
        <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <div style="flex: 1; min-width: 250px;">
                <input type="text" name="search" class="form-control" placeholder="üîç Search all columns..." value="{{ search_query }}">
            </div>
            <div>
                <select name="filter_column" class="form-control" style="width: 180px;">
                    <option value="">Filter by column...</option>
                    {% for col in columns %}
                    <option value="{{ col }}" {% if col == filter_column %}selected{% endif %}>{{ col }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <input type="text" name="filter_value" class="form-control" placeholder="Filter value" style="width: 150px;" value="{{ filter_value }}">
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <a href="{% url 'view_tab' tab.id %}" class="btn btn-secondary btn-sm">Clear</a>
        </form>
        <small style="color: #666; margin-top: 0.5rem; display: block;">
            Showing <strong>{{ records|length }}</strong> of <strong>{{ total_records }}</strong> records
            {% if search_query or filter_column %}<span style="color: #d9534f;"> (filtered)</span>{% endif %}
        </small>
    </div>
</div>
{% endif %}

<!-- Excel-Like Table -->
{% if records %}
<div class="card">
    <div class="card-body" style="overflow-x: auto;">
        <table class="table excel-table" id="dataTable">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    {% for col in columns %}
                    <th style="min-width: 150px;">{{ col }}</th>
                    {% endfor %}
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr data-record-id="{{ record.id }}">
                    <td class="id-cell">#{{ record.id }}</td>
                    {% for col in columns %}
                    <td class="data-cell {% if can_edit %}editable{% endif %}" data-record-id="{{ record.id }}" data-column="{{ col }}" data-value="{{ record.data|get_item:col|default:'' }}" {% if can_edit %}title="Double-click to edit"{% endif %}>
                        <span class="cell-content">{{ record.data|get_item:col|default:"-" }}</span>
                        {% if can_edit %}
                        <span class="edit-icon">‚úèÔ∏è</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="actions-cell">
                        <div>
                            {% if can_delete %}
                            <button class="btn btn-sm btn-danger" onclick="deleteRecordInline({{ record.id }})" style="padding: 0.25rem 0.5rem;">üóëÔ∏è</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination" style="margin-top: 1.5rem;">
    {% if page_obj.has_previous %}
    <a href="?search={{ search_query }}&filter_column={{ filter_column }}&filter_value={{ filter_value }}&page=1">First</a>
    <a href="?search={{ search_query }}&filter_column={{ filter_column }}&filter_value={{ filter_value }}&page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
    <span class="current">{{ num }}</span>
    {% else %}
    <a href="?search={{ search_query }}&filter_column={{ filter_column }}&filter_value={{ filter_value }}&page={{ num }}">{{ num }}</a>
    {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?search={{ search_query }}&filter_column={{ filter_column }}&filter_value={{ filter_value }}&page={{ page_obj.next_page_number }}">Next</a>
    <a href="?search={{ search_query }}&filter_column={{ filter_column }}&filter_value={{ filter_value }}&page={{ page_obj.paginator.num_pages }}">Last</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body text-center">
        <p>No records yet</p>
        {% if can_add %}
        <a href="{% url 'add_record' tab.id %}" class="btn btn-success">Add First Record</a>
        {% endif %}
    </div>
</div>
{% endif %}

<style>
    /* Excel-like table styling */
    .excel-table {
        border-collapse: collapse;
    }
    
    .data-cell {
        position: relative;
        padding: 0.5rem !important;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
        max-width: 300px;
        word-break: break-word;
    }
    
    .data-cell:hover {
        background-color: #fff9c4;
    }
    
    .data-cell .edit-icon {
        position: absolute;
        right: 2px;
        top: 2px;
        opacity: 0;
        font-size: 0.8rem;
        transition: opacity 0.2s;
    }
    
    .data-cell:hover .edit-icon {
        opacity: 1;
    }
    
    .data-cell.editing {
        padding: 0 !important;
        background-color: #e3f2fd;
    }
    
    .data-cell.editing .cell-content {
        display: none;
    }
    
    .id-cell {
        font-weight: bold;
        background-color: #f5f5f5;
        text-align: center;
    }
    
    .actions-cell {
        text-align: center;
        padding: 0.5rem !important;
    }
</style>

<script>
const csrftoken = getCookie('csrftoken');

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Make cells editable on double-click
    document.querySelectorAll('.data-cell.editable').forEach(cell => {
        cell.addEventListener('dblclick', function() {
            editCell(this);
        });
    });
});

function editCell(cell) {
    if (cell.classList.contains('editing')) return;
    
    const recordId = cell.getAttribute('data-record-id');
    const column = cell.getAttribute('data-column');
    const currentValue = cell.getAttribute('data-value');
    
    // Create input field
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.value = currentValue;
    input.style.cssText = 'width: 100%; padding: 0.5rem; border: 2px solid #007bff; margin: 0;';
    
    // Clear cell and add input
    cell.classList.add('editing');
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    function saveCell() {
        const newValue = input.value;
        
        // Save to server
        fetch(`/record/${recordId}/update-cell/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                column: column,
                value: newValue
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cell.classList.remove('editing');
                cell.setAttribute('data-value', newValue);
                const contentSpan = document.createElement('span');
                contentSpan.className = 'cell-content';
                contentSpan.textContent = newValue || '-';
                
                const editIcon = document.createElement('span');
                editIcon.className = 'edit-icon';
                editIcon.textContent = '‚úèÔ∏è';
                
                cell.innerHTML = '';
                cell.appendChild(contentSpan);
                cell.appendChild(editIcon);
                
                // Show success feedback
                cell.style.backgroundColor = '#c8e6c9';
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                }, 500);
            } else {
                alert('Error: ' + data.error);
                cancelEdit(cell, currentValue, column);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to save cell');
            cancelEdit(cell, currentValue, column);
        });
    }
    
    function cancelEdit(cell, value, col) {
        cell.classList.remove('editing');
        cell.setAttribute('data-value', value);
        const contentSpan = document.createElement('span');
        contentSpan.className = 'cell-content';
        contentSpan.textContent = value || '-';
        
        const editIcon = document.createElement('span');
        editIcon.className = 'edit-icon';
        editIcon.textContent = '‚úèÔ∏è';
        
        cell.innerHTML = '';
        cell.appendChild(contentSpan);
        cell.appendChild(editIcon);
    }
    
    // Save on Enter, cancel on Escape
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveCell();
        } else if (e.key === 'Escape') {
            cancelEdit(cell, currentValue, column);
        }
    });
    
    // Save on blur (click away)
    input.addEventListener('blur', saveCell);
}

function deleteRecordInline(recordId) {
    if (!confirm('Are you sure you want to delete this record?')) {
        return;
    }
    
    fetch(`/record/${recordId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove row from table
            const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
            if (row) {
                row.style.opacity = '0.5';
                row.style.textDecoration = 'line-through';
                setTimeout(() => {
                    row.remove();
                }, 300);
            }
            alert('Record deleted successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete record');
    });
}
</script>
{% endblock %}
